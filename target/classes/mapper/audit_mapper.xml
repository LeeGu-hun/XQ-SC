<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="auditSQL">

	<!-- ***************** audit List************/********** -->


	<select id="auditAllList" resultType="bean.AuditBean">
        SELECT ROWNUM RNUM,
		v.VENDOR_NAME, v.VENDOR_ADDRESS,
		v.VENDOR_ID,
		v.VENDOR_Q_NAME,v.VENDOR_Q_TEL,
		v.VENDOR_S_NAME,v.VENDOR_S_TEL,
		v.AUDIT_NEXT_DATE,a.audit_plan_date
		FROM VENDOR_INFO v , audit_info a
		WHERE v.vendor_id= a.vendor_id and v.vendor_valid='Y'
        and a.audit_next_date <![CDATA[ <= ]]> (sysdate+30) 
        or 
        a.audit_next_date
        != null
               and v.vendor_id not in 
        (select vendor_id from audit_info)
	</select>


	<select id="allCount" resultType="int">
	     SELECT count (*) 
		FROM VENDOR_INFO v , audit_info a
		WHERE v.vendor_id= a.vendor_id and v.vendor_valid='Y'
        and a.audit_next_date <![CDATA[ <= ]]> (sysdate+30) 
        or 
        a.audit_next_date
        != null
               and v.vendor_id not in 
        (select vendor_id from audit_info)

	</select>

	<select id="allList" resultType="int">
		SELECT COUNT(*) FROM AUDIT_INFO
	</select>



	<!-- ************** audit plan Insert************* -->
	<insert id="newAuditPlan" parameterType="bean.AuditBean">
		INSERT INTO
		AUDIT_INFO
		(AUDIT_ID, AUDIT_KIND_ID, AUDITOR_ID, VENDOR_ID,AUDIT_PLAN_DATE)
		VALUES(
		#{AUDIT_ID},
		#{AUDIT_KIND_ID},
		#{AUDITOR_ID},
		#{VENDOR_ID},
		#{AUDIT_PLAN_DATE})
	</insert>
	

	<!-- 카테고리 리스트 -->
	<select id="cateList" resultType="bean.BeanCategory">
		SELECT * FROM CATEGORY_INFO
		ORDER BY CATEGORY_NAME
	</select>

	<!-- 물품 리스트 -->
	<select id="prodList" resultType="bean.BeanProduct"
		parameterType="String">
		select * from product_item
		where CATEGORY_ID =
		#{CATEGORY_ID}
	</select>

	<!-- check list RE -->
	<select id="checkListRE" resultType="bean.CheckListBean"
		parameterType="String">
		SELECT
		ROWNUM RNUM,
		CHECKLIST_DISCRIPTION,
		CHECKLIST_FULLSCORE,
		CHECKLIST_ID
		FROM
		CHECKLIST where audit_kind_id =
		'RE'
		AND
		CHECKLIST_VALID = 'Y'
	</select>

	<!-- check list NE -->
	<select id="checkListNE" resultType="bean.CheckListBean"
		parameterType="String">
		SELECT
		ROWNUM RNUM,
		CHECKLIST_DISCRIPTION,
		CHECKLIST_FULLSCORE,
		CHECKLIST_ID
		FROM
		CHECKLIST where audit_kind_id =
		'NE'
		AND
		CHECKLIST_VALID = 'Y'
	</select>


	<!-- audit Type 리스트 -->
	<select id="auditType" resultType="bean.AuditKind">
		SELECT * FROM AUDIT_KIND
	</select>

	<select id="auditListReport" resultType="bean.AuditBean" parameterType="bean.DateCommand">
		SELECT
		ROWNUM RNUM,
		AU.AUDIT_ID,
		V.VENDOR_NAME,
		V.VENDOR_ID,
		C.CATEGORY_NAME,
		V.VENDOR_ADDRESS,
		P.PRODUCT_NAME,
		P.PRODUCT_ID,
		Au.AUDIT_PLAN_DATE,
		Au.AUDIT_KIND_ID,
		M. MEMBER_NAME,
		M.MEMBER_ID
		FROM
		VENDOR_INFO V,
		PRODUCT_ITEM P,
		AUDIT_INFO AU,
		MEMBER_INFO M,
		CATEGORY_INFO C

		WHERE
		M.MEMBER_ID = AU.AUDITOR_ID
		AND V.VENDOR_ID =
		AU.VENDOR_ID
		AND
		P.PRODUCT_ID = V.PRODUCT_ID
		AND P.CATEGORY_ID =
		C.CATEGORY_ID
		AND
		AU.AUDIT_PLAN_DATE IS NOT NULL
		and au.audit_id not in (select audit_id from audit_result)
		<include refid="planDate"></include>
	</select>


	<select id="auditId" resultType="int">
		SELECT COUNT(*) FROM AUDIT_INFO
	</select>


	<!-- ************* INSERT ************* -->
	<insert id="auditSumit" parameterType="bean.AuditSubmitBean">
		INSERT INTO audit_info
		VALUES(
		#{CHECKLIST_ID},
		#{CHECKLIST_DISCRIPTION},
		#{AUDIT_KIND_ID},
		#{CHECKLIST_FULLSCORE},
		#{CHECKLIST_VALID}
		)
	</insert>
	
	<!-- audit  pass -->
	<update id="nextDate" parameterType="bean.AuditBean">
	UPDATE VENDOR_INFO SET AUDIT_NEXT_DATE = 
	SYSDATE+
	(SELECT AUDIT_KIND_PERIOD *365  FROM AUDIT_KIND WHERE AUDIT_KIND_ID = 'RE'), 
	AUDIT_RESULT = 'Y'
	WHERE VENDOR_ID =  #{VENDOR_ID}
	</update>
	
		<!-- audit not pass -->
	<update id="nextDateFalse" parameterType="bean.AuditBean">
	UPDATE VENDOR_INFO SET 
	AUDIT_RESULT = 'N'
	WHERE VENDOR_ID =  #{VENDOR_ID}
	</update>

	<!-- audit Result Id -->
	<select id="resultCount" resultType="int">
		SELECT COUNT(*) FROM
		AUDIT_RESULT
	</select>

	<!-- check list *result* insert -->
	<insert id="checkResult" parameterType="bean.AuditSubmitBean">
		INSERT INTO AUDIT_RESULT
		VALUES(
		#{AUDIT_RESULT_ID},
		#{AUDIT_ID},
		#{CHECKLIST_ID},
		#{AUDIT_SCORE})
	</insert>

	<!-- 점수 입력하기 -->
	<update id="updateScore" parameterType="bean.AuditBean">
		UPDATE AUDIT_INFO
		SET
		AUDIT_SCORE = #{AUDIT_SCORE},
		AUDIT_RSINPUT_DATE = #{AUDIT_RSINPUT_DATE},
		AUDIT_COMP_DATE = #{AUDIT_COMP_DATE},
		AUDIT_NEXT_DATE = 
		SYSDATE+(SELECT AUDIT_KIND_PERIOD *365  FROM AUDIT_KIND WHERE AUDIT_KIND_ID = 'RE'),
		AUDIT_RESULT = 'Y'
		WHERE AUDIT_ID
		= #{AUDIT_ID}
	</update>


	<!-- Auditor Select -->


	<select id="getAuditorList" parameterType="String" resultType="bean.BeanMember">
		select distinct a.auditor_id,m.member_name as auditor_name from
		audit_info a, member_info m where m.member_id=a.auditor_id and
		m.member_name like '%'||#{auditor_name}||'%'

	</select>


	<select id="getCheakResult" parameterType="String" resultType="bean.CheckListBean">
		SELECT
		ROWNUM RNUM,
		C.CHECKLIST_DISCRIPTION,
		RE.AUDIT_SCORE FROM
		AUDIT_RESULT RE,
		CHECKLIST C
		WHERE AUDIT_ID = #{id}
		AND
		RE.CHECKLIST_ID =
		C.CHECKLIST_ID
	</select>


	<select id="resultSearch" resultType="bean.AuditResultSearch">
		SELECT

		AU.AUDIT_ID,
		P.PRODUCT_ID,
		V.VENDOR_NAME,
		V.VENDOR_ID,
		AU.AUDIT_PLAN_DATE,
		AU.AUDIT_RSINPUT_DATE,
		AU.AUDIT_RESULT,
		AU.AUDIT_NEXT_DATE,
		AU.AUDIT_COMP_DATE,
		ROWNUM RNUM,
		AU.AUDIT_KIND_ID,
		M.MEMBER_NAME,
		M.MEMBER_ID,
		M.MEMBER_TEL,
		V.VENDOR_Q_NAME,
		V.VENDOR_Q_TEL,
		V.VENDOR_S_NAME,
		V.VENDOR_S_TEL,
		V.VENDOR_ADDRESS,
		AU.AUDIT_SCORE
		FROM
		VENDOR_INFO V,
		PRODUCT_ITEM P,
		AUDIT_INFO AU,
		MEMBER_INFO M
		WHERE
		M.MEMBER_ID =
		AU.AUDITOR_ID
		AND V.VENDOR_ID =
		AU.VENDOR_ID
		AND
		P.PRODUCT_ID =
		V.PRODUCT_ID
		<include refid="searchDate"></include>
	</select>

	<sql id="searchDate">
		<choose>
			<when test="vendor != null">
				AND VENDOR_NAME = #{vendor}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</sql>

	<select id="getByPlanDate" parameterType="bean.DateCommand"
		resultType="bean.AuditResultSearch">
		SELECT
		AU.AUDIT_ID,
		P.PRODUCT_ID,
		P.PRODUCT_NAME,
		V.VENDOR_NAME,
		V.VENDOR_ID,
		AU.AUDIT_PLAN_DATE,
		AU.AUDIT_RSINPUT_DATE,
		AU.AUDIT_RESULT,
		AU.AUDIT_NEXT_DATE,
		AU.AUDIT_COMP_DATE,
		ROWNUM RNUM,
		AU.AUDIT_KIND_ID,
		M.MEMBER_NAME,
		M.MEMBER_ID,
		M.MEMBER_TEL,
		V.VENDOR_Q_NAME,
		V.VENDOR_Q_TEL,
		V.VENDOR_S_NAME,
		V.VENDOR_S_TEL,
		V.VENDOR_ADDRESS,
		AU.AUDIT_SCORE
		FROM
		VENDOR_INFO V,
		PRODUCT_ITEM P,
		AUDIT_INFO AU,
		MEMBER_INFO M
		WHERE
		M.MEMBER_ID =
		AU.AUDITOR_ID
		AND V.VENDOR_ID =
		AU.VENDOR_ID
		AND
		P.PRODUCT_ID =
		V.PRODUCT_ID
		<include refid="planDate"></include>
		order by AUDIT_PLAN_DATE
	</select>

	<sql id="planDate">
		<choose>
			<when test="from != null">
				AND AUDIT_PLAN_DATE
				BETWEEN #{from} AND
				#{to}
				<if test="vSearch !=null">
					and vendor_name like '%'||#{vSearch}||'%'
				</if>
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</sql>

	<select id="getByScoreDate" parameterType="bean.DateCommand"
		resultType="bean.AuditResultSearch">
		SELECT
		AU.AUDIT_ID,
		P.PRODUCT_ID,
		V.VENDOR_NAME,
		V.VENDOR_ID,
		AU.AUDIT_PLAN_DATE,
		AU.AUDIT_RSINPUT_DATE,
		AU.AUDIT_RESULT,
		AU.AUDIT_NEXT_DATE,
		AU.AUDIT_COMP_DATE,
		ROWNUM RNUM,
		AU.AUDIT_KIND_ID,
		M.MEMBER_NAME,
		M.MEMBER_ID,
		M.MEMBER_TEL,
		V.VENDOR_Q_NAME,
		V.VENDOR_Q_TEL,
		V.VENDOR_S_NAME,
		V.VENDOR_S_TEL,
		V.VENDOR_ADDRESS,
		AU.AUDIT_SCORE
		FROM
		VENDOR_INFO V,
		PRODUCT_ITEM P,
		AUDIT_INFO AU,
		MEMBER_INFO M
		WHERE
		M.MEMBER_ID =
		AU.AUDITOR_ID
		AND V.VENDOR_ID =
		AU.VENDOR_ID
		AND
		P.PRODUCT_ID =
		V.PRODUCT_ID
		<include refid="scoreDate"></include>
		order by AUDIT_PLAN_DATE
	</select>

	<sql id="scoreDate">
		<choose>
			<when test="from != null">
				AND AUDIT_RSINPUT_DATE
				BETWEEN #{from} AND
				#{to}
				<if test="vSearch !=null">
					and vendor_name like '%'||#{vSearch}||'%'
				</if>
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</sql>
</mapper>

